name: Check TOC References

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-toc:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Get list of changed files
      id: changed-files
      run: |
        changed_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep '\.md$')
        if [ -z "$changed_files" ]; then
          echo "No markdown files changed."
          exit 0
        fi
        echo "changed_files<<EOF" >> $GITHUB_ENV
        echo "$changed_files" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Check TOC references
      run: |
        missing_files=()
        while IFS= read -r file; do
          if [ -z "$file" ]; then
            continue
          fi
          folder=$(dirname "$file")
          toc_file="$folder/toc.yml"
          if [ -f "$toc_file" ]; then
            if ! grep -q "href: $file" "$toc_file"; then
              missing_files+=("$file")
            else
              echo "File $file is referenced in $toc_file " "$(grep "href: $file" "$toc_file")"
            fi
          else
            echo "TOC file not found in $folder"
            exit 1
          fi
        done < <(echo "${{ steps.changed-files.outputs.changed_files }}")

        if [ ${#missing_files[@]} -ne 0 ]; then
          echo "The following markdown files are missing in their respective toc.yml:"
          for file in "${missing_files[@]}"; do
            echo "$file"
          done
          exit 1
        fi
